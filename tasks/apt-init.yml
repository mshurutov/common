---
- name: Set system repos
  ansible.builtin.template:
    dest: "/etc/apt/sources.list"
    src: "{{ common_etc_templates_path }}/apt_sources.list.j2"
    mode: "0644"
  when: apt_system_repos | length > 0
  tags: apt_init,apt_set_system_repos

- name: Update packages cache
  ansible.builtin.apt:
    update_cache: true
  tags: apt_init,apt_update_cache

- name: Upgrade system
  ansible.builtin.apt:
    name: "*"
    state: latest
    only_upgrade: true
  when: apt_upgrade_force is defined and apt_upgrade_force | bool
  tags: apt_init,apt_upgrade_system

- name: Install system packages
  ansible.builtin.apt:
    name: "{{ apt_system_packages }}"
  tags: apt_init,system_install

- name: Set python3 default interpreter
  community.general.alternatives:
    name: "python"
    link: "/usr/bin/python"
    path: "{{ item.path }}"
    priority: "{{ item.priority }}"
    state: "{{ item.state }}"
  loop: "{{ apt_python }}"
  tags: set_python

- name: Add repos gpg key
  ansible.builtin.apt_key:
    url: "{{ item.gpg_key }}"
    state: present
  loop: "{{ apt_repo_list }}"
  tags: apt_init,apt_add_repo

- name: Add repos
  ansible.builtin.apt_repository:
    codename: "{{ item.codename }}"
    repo: "{{ item.repo }}"
    filename: "{{ item.filename }}"
    state: "{{ item.state | default(omit) }}"
  loop: "{{ apt_repo_list }}"
  tags: apt_init,apt_add_repo
